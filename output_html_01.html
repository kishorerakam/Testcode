<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Lineage Graph</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://unpkg.com/dagre-d3@0.6.4/dist/dagre-d3.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    svg {
      width: 100%;
      height: 800px;
      display: none;
      border: 1px solid #ccc;
    }
    input {
      margin-bottom: 15px;
      font-size: 16px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <h2>Table Lineage Viewer</h2>
  <input type="text" id="tableSearch" placeholder="Enter table name..." />
  <div id="placeholder" style="margin-top: 10px; color: gray;">Please enter the table name to view its lineage.</div>
  <svg></svg>
<script>
  const svg = d3.select("svg");
  const svgGroup = svg.append("g");

  // Add zoom and pan behavior
  const zoom = d3.zoom().on("zoom", function (event) {
    svgGroup.attr("transform", event.transform);
  });
  svg.call(zoom);

  // Define arrow marker
  svg.append("defs").append("marker")
    .attr("id", "arrowhead")
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 20)
    .attr("refY", 0)
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
    .append("path")
    .attr("d", "M0,-5L10,0L0,5")
    .attr("fill", "#333");

  document.getElementById("tableSearch").addEventListener("input", function () {
    const term = this.value.trim().toLowerCase();

    if (!term) {
      svg.style("display", "none");
      document.getElementById("placeholder").style.display = "block";
      document.getElementById("placeholder").textContent = "Please enter the table name to view its lineage.";
      svgGroup.selectAll("*").remove();
      return;
    }

    fetch("lineage_output.json")
      .then(res => res.json())
      .then(data => {
        const g = new dagreD3.graphlib.Graph().setGraph({
          rankdir: "LR",
          ranksep: 80,
          nodesep: 100,
          marginx: 20,
          marginy: 20
        });

        const relatedNodes = new Set();
        const relatedEdges = [];

        function findConnected(table, direction = "both") {
          if (!table) return;
          relatedNodes.add(table);

          if (direction !== "up") {
            data.links.forEach(link => {
              if (link.source.toLowerCase() === table && !relatedNodes.has(link.target.toLowerCase())) {
                relatedEdges.push(link);
                findConnected(link.target.toLowerCase(), direction);
              }
            });
          }

          if (direction !== "down") {
            data.links.forEach(link => {
              if (link.target.toLowerCase() === table && !relatedNodes.has(link.source.toLowerCase())) {
                relatedEdges.push(link);
                findConnected(link.source.toLowerCase(), direction);
              }
            });
          }
        }

        findConnected(term);

        if (relatedNodes.size === 0) {
          svg.style("display", "none");
          document.getElementById("placeholder").style.display = "block";
          document.getElementById("placeholder").textContent = `No lineage found for "${term}"`;
          svgGroup.selectAll("*").remove();
          return;
        }

        svgGroup.selectAll("*").remove();

        data.nodes.forEach(node => {
          if (relatedNodes.has(node.id.toLowerCase())) {
            const bgColor =
              node.type === 'source' ? "#b2dfdb"
              : node.type === 'target' ? "#c8e6c9"
              : "#f8bbd0";
            g.setNode(node.id, {
              labelType: "text",
              label: `${node.id}${node.operation ? '\n(' + node.operation + ')' : ''}`,
              style: `fill: ${bgColor}; stroke: #333; stroke-width: 1.5px;`,
              padding: 10,
              rx: 6,
              ry: 6
            });
          }
        });

        relatedEdges.forEach(link => {
          const isDashed = /left|right|full|outer/i.test(link.join_type || "");
          g.setEdge(link.source, link.target, {
            arrowhead: "vee",
            lineInterpolate: "basis",
            label: link.join_type || "",
            style: `
              stroke: #333;
              stroke-width: 1.5px;
              stroke-dasharray: ${isDashed ? "4,2" : "none"};
              marker-end: url(#arrowhead);
              fill: none;
            `,
            labelStyle: "font-size: 11px; fill: #000; font-weight: bold;"
          });
        });

        const render = new dagreD3.render();
        render(svgGroup, g);

        const xCenterOffset = Math.max(0, (svg.node().getBoundingClientRect().width - g.graph().width) / 2);
        svgGroup.attr("transform", "translate(" + xCenterOffset + ", 40)");
        svg.attr("height", g.graph().height + 80);
        svg.style("display", "block");
        document.getElementById("placeholder").style.display = "none";
      });
  });

  // Optional: add Enter key support
  document.getElementById("tableSearch").addEventListener("keypress", function(e) {
    if (e.key === 'Enter') {
      this.dispatchEvent(new Event('input'));
    }
  });
</script>
</body>
</html>
